// Generated by CoffeeScript 1.6.3
(function() {
  var activateTooltips, addResultDetailsViewListener, addResultSynsetMouseenterListener, bindFunctions, createMclClusterLabelsDict, detailsViewOrderImagesByMclCluster, openResultDetailsModalView, recursivelyPositionTooltips, searchDataArrived, setResultsMinHeight,
    _this = this,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  this.newSearch = function() {
    var searchterm;
    searchterm = $('#input-searchterm').val();
    $('#loading-popup-searchterm').text(searchterm);
    $('#loading-popup').modal('show');
    return $('#results').load("http://localhost:5000/search/" + searchterm + " #result-container", searchDataArrived).fadeIn("slow");
  };

  searchDataArrived = function(responseText, textStatus, XMLHttpRequest) {
    if (textStatus !== "success") {
      $('#loading-popup');
    }
    $('#loading-popup').modal('hide');
    console.log("Search data arrived:", textStatus);
    activateTooltips();
    addResultDetailsViewListener();
    return addResultSynsetMouseenterListener();
  };

  openResultDetailsModalView = function(targetNode) {
    var images, mclClusterLabels, mclClusters;
    $("#cluster-detail-popup-synset").text($(targetNode).siblings(".result-title").children(".result-name").text());
    $("#cluster-detail-popup-definition em").text($(targetNode).siblings(".result-title").children(".result-description").text());
    $("#cluster-detail-popup > .modal-body").empty();
    mclClusters = $(targetNode).children();
    mclClusterLabels = createMclClusterLabelsDict(mclClusters);
    images = $(mclClusters).children();
    $("#cluster-detail-popup > .modal-body").append(images.clone().height(120));
    detailsViewOrderImagesByMclCluster(mclClusterLabels);
    $("#cluster-detail-popup .modal-body").css("max-height", ($(window).height() * 0.95 - $("#cluster-detail-popup .modal-header").outerHeight() - $("#cluster-detail-popup .modal-footer").outerHeight()) * 0.8);
    return $("#cluster-detail-popup").modal("show");
  };

  createMclClusterLabelsDict = function(mclClusters) {
    var mclCluster, mclClusterLabels, mclClusterNr, _i, _len;
    mclClusterLabels = {};
    for (_i = 0, _len = mclClusters.length; _i < _len; _i++) {
      mclCluster = mclClusters[_i];
      mclClusterNr = $(mclCluster).attr("data-mcl-cluster-index");
      if (__indexOf.call(mclClusterLabels, mclClusterNr) < 0) {
        mclClusterLabels[mclClusterNr] = $(mclCluster).attr("data-mcl-synset-description");
      }
    }
    return mclClusterLabels;
  };

  detailsViewOrderImagesByMclCluster = function(mclClusterLabels) {
    var $image, $synsetImages, dict, domImage, mclCluster, mclClusterName, visualCluster, visualClusterName, _i, _len, _results;
    $synsetImages = $("#cluster-detail-popup > .modal-body > img");
    dict = {};
    for (_i = 0, _len = $synsetImages.length; _i < _len; _i++) {
      domImage = $synsetImages[_i];
      $image = $(domImage);
      mclClusterName = $image.attr("data-mcl-cluster");
      visualClusterName = $image.attr("data-visual-cluster");
      if (!dict[mclClusterName]) {
        dict[mclClusterName] = {};
      }
      if (!dict[mclClusterName][visualClusterName]) {
        dict[mclClusterName][visualClusterName] = [];
      }
      dict[mclClusterName][visualClusterName].push($image[0]);
    }
    _results = [];
    for (mclClusterName in dict) {
      mclCluster = dict[mclClusterName];
      $("#cluster-detail-popup > .modal-body").append("<div class='mcl-cluster'></div>");
      $("#cluster-detail-popup > .modal-body > .mcl-cluster:last-child").append("<div class='mcl-synsets-label pull-right'>" + mclClusterLabels[mclClusterName] + "</div>");
      for (visualClusterName in mclCluster) {
        visualCluster = mclCluster[visualClusterName];
        $("#cluster-detail-popup > .modal-body > .mcl-cluster:last-child").append("<div class='visual-cluster pull-left'></div>");
        $("#cluster-detail-popup > .modal-body > .mcl-cluster:last-child > .visual-cluster:last-child").append(visualCluster);
      }
      $("#cluster-detail-popup > .modal-body > .mcl-cluster:last-child > .visual-cluster:last-child").append("<div class='clearfix'></div>");
      _results.push($("#cluster-detail-popup > .modal-body").append("<div class='clearfix'></div>"));
    }
    return _results;
  };

  addResultDetailsViewListener = function() {
    return $(".result-preview").click(function(event) {
      $(".tooltip").remove();
      return openResultDetailsModalView(event.currentTarget);
    });
  };

  addResultSynsetMouseenterListener = function() {
    $('.result-synset').mouseenter(function(event) {
      var $hoveredSynset;
      event.stopPropagation();
      $hoveredSynset = $(this);
      return recursivelyPositionTooltips($hoveredSynset, $hoveredSynset.position().top);
    });
    return $('.result-synset').mouseleave(function() {
      return $(this).tooltip("hide");
    });
  };

  recursivelyPositionTooltips = function(synsetNode, topPosition) {
    synsetNode.tooltip("show");
    synsetNode.siblings('.tooltip').css("top", topPosition);
    if (synsetNode.parent().hasClass('result-synset')) {
      return recursivelyPositionTooltips(synsetNode.parent(), topPosition - (synsetNode.siblings('.tooltip').height() + 10));
    }
  };

  activateTooltips = function() {
    $('.result-synset').tooltip({
      selector: '',
      placement: 'left',
      html: 'true',
      trigger: 'manual'
    });
    return $('img').tooltip({
      selector: '',
      placement: 'bottom',
      html: 'true'
    });
  };

  bindFunctions = function() {
    return $('#input-searchterm').keyup(function(e) {
      if (e.keyCode === 13) {
        return newSearch();
      }
    });
  };

  setResultsMinHeight = function() {
    return $("#results").css("min-height", $('body').height() - $('#main-navigation').height() - $('footer').height());
  };

  $.ready = function() {
    $(".modal").modal().on("shown", function() {
      return $("body").css("overflow", "hidden");
    }).on("hidden", function() {
      return $("body").css("overflow", "auto");
    });
    $('#loading-popup').modal('hide');
    $('#cluster-detail-popup').modal('hide');
    bindFunctions();
    $("#input-searchterm").focus();
    setResultsMinHeight();
    return window.onbeforeunload = function() {
      return 'Do you really want to leave the page?';
    };
  };

}).call(this);
